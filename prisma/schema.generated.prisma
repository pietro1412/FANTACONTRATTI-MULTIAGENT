// =============================================================================
// GENERATED FILE - DO NOT EDIT DIRECTLY
// =============================================================================
// This file is auto-generated by scripts/build-schema.ts
// To make changes, edit the source files in prisma/schemas/
// Then run: npm run db:build-schema
// =============================================================================

// =============================================================================
// GENERATED FILE - DO NOT EDIT DIRECTLY
// =============================================================================
// This file is auto-generated by scripts/build-schema.ts
// To make changes, edit the source files in prisma/schemas/
// Then run: npm run db:build-schema
// =============================================================================
// =============================================================================
// schema.prisma - Main Entry Point
// =============================================================================
//
// This file contains ONLY the generator and datasource configuration.
// All models and enums are defined in prisma/schemas/*.prisma files.
//
// To generate the combined schema, run:
//   npm run db:build-schema
//
// This will create prisma/schema.generated.prisma with all models combined.
//
// Then use the generated schema for Prisma commands:
//   npx prisma generate --schema=prisma/schema.generated.prisma
//   npx prisma db push --schema=prisma/schema.generated.prisma
//   npx prisma migrate dev --schema=prisma/schema.generated.prisma
//
// =============================================================================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}


// =============================================================================
// Source: prisma/schemas/_base.prisma
// =============================================================================
// =============================================================================
// _base.prisma - Shared Enums
// =============================================================================
//
// This file contains all shared enums used across multiple models.
// It is loaded first (underscore prefix ensures alphabetical priority).
//
// =============================================================================

// ==================== LEAGUE STATUS ====================
enum LeagueStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

// ==================== MEMBER ENUMS ====================
enum MemberRole {
  ADMIN
  MANAGER
}

enum MemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
  LEFT
}

enum JoinType {
  CREATOR   // Creatore della lega (auto-admin)
  INVITE    // Invitato via email (auto-entra)
  REQUEST   // Richiesta spontanea (admin approva)
}

// ==================== PLAYER ENUMS ====================
enum Position {
  P  // Portiere
  D  // Difensore
  C  // Centrocampista
  A  // Attaccante
}

enum PlayerListStatus {
  IN_LIST       // Presente nella lista quotazioni corrente
  NOT_IN_LIST   // Non piu in lista (serie B, estero, etc.)
}

enum PlayerExitReason {
  RITIRATO      // Il giocatore ha smesso di giocare
  RETROCESSO    // Il giocatore e' retrocesso in Serie B o inferiore
  ESTERO        // Il giocatore e' andato in una lega estera
}

// ==================== ROSTER ENUMS ====================
enum AcquisitionType {
  FIRST_MARKET
  RUBATA
  SVINCOLATI
  TRADE
}

enum RosterStatus {
  ACTIVE
  RELEASED
  TRADED
}

// ==================== MARKET SESSION ENUMS ====================
enum MarketType {
  PRIMO_MERCATO
  MERCATO_RICORRENTE
}

enum SessionStatus {
  SCHEDULED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum MarketPhase {
  ASTA_LIBERA                    // Solo per PRIMO_MERCATO
  OFFERTE_PRE_RINNOVO            // Prima fase MERCATO_RICORRENTE - scambi/offerte pre rinnovo
  PREMI                          // Assegnazione premi budget ai manager
  CONTRATTI                      // Rinnovo contratti
  CALCOLO_INDENNIZZI             // Gestione giocatori usciti (ritirato, retrocesso, estero)
  RUBATA                         // Asta forzata
  ASTA_SVINCOLATI                // Asta svincolati (solo MERCATO_RICORRENTE)
  OFFERTE_POST_ASTA_SVINCOLATI   // Fase finale - scambi/offerte post svincolati
}

// ==================== AUCTION ENUMS ====================
enum AuctionType {
  FREE_BID        // Asta libera (PRIMO MERCATO e SVINCOLATI)
  RUBATA          // Asta rubata (forzata)
}

enum AuctionStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
  NO_BIDS
  APPEAL_REVIEW           // Asta conclusa ma con ricorso PENDING da gestire
  AWAITING_APPEAL_ACK     // Ricorso risolto, in attesa che tutti prendano visione
  AWAITING_RESUME         // Ricorso ACCEPTED, in attesa ready check per riprendere
}

enum AppealStatus {
  PENDING    // In attesa di revisione
  ACCEPTED   // Accettato - asta riaperta
  REJECTED   // Respinto - esito confermato
}

enum ObjectiveStatus {
  ACTIVE     // Obiettivo ancora valido
  ACQUIRED   // Giocatore acquistato
  MISSED     // Giocatore perso ad altri
  REMOVED    // Rimosso manualmente
}

// ==================== TRADE ENUMS ====================
enum TradeStatus {
  PENDING
  ACCEPTED
  REJECTED
  COUNTERED
  CANCELLED
  EXPIRED
}

// ==================== INVITE ENUMS ====================
enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ==================== MOVEMENT ENUMS ====================
enum MovementType {
  FIRST_MARKET          // Primo mercato assoluto
  TRADE                 // Scambio
  RUBATA                // Rubata
  SVINCOLATI            // Acquisto svincolato
  RELEASE               // Svincolo (contratto scaduto o volontario)
  CONTRACT_RENEW        // Rinnovo contratto
  RETIREMENT            // Ritirato - contratto risolto
  RELEGATION_RELEASE    // Retrocesso - rilasciato senza compenso
  RELEGATION_KEEP       // Retrocesso - mantenuto in rosa
  ABROAD_COMPENSATION   // Estero - rilasciato con compenso
  ABROAD_KEEP           // Estero - mantenuto in rosa
}

// ==================== PROPHECY ENUMS ====================
enum ProphecyRole {
  BUYER   // Chi acquista
  SELLER  // Chi cede
}


// =============================================================================
// Source: prisma/schemas/admin.prisma
// =============================================================================
// =============================================================================
// admin.prisma - AuditLog
// =============================================================================
//
// This file contains models for administration and audit logging.
//
// =============================================================================

model AuditLog {
  id          String   @id @default(cuid())

  userId      String?
  user        User?    @relation(fields: [userId], references: [id])  // see: identity.prisma

  leagueId    String?
  league      League?  @relation(fields: [leagueId], references: [id])  // see: league.prisma

  action      String
  entityType  String?
  entityId    String?
  oldValues   Json?
  newValues   Json?

  ipAddress   String?
  userAgent   String?

  createdAt   DateTime @default(now())
}


// =============================================================================
// Source: prisma/schemas/alert.prisma
// =============================================================================
// =============================================================================
// alert.prisma - PlayerAlert, PlayerAlertNotification
// =============================================================================
//
// This file contains models for the player alert system.
// Alerts are created when important events happen to players (injury, form change,
// transfer, etc.) and notifications are sent to managers who watch those players.
//
// =============================================================================

// Types of alerts that can be generated
enum AlertType {
  INJURY              // Player injured
  SUSPENSION          // Player suspended (red card, accumulated yellows)
  FORM_UP             // Player form improved significantly
  FORM_DOWN           // Player form decreased significantly
  GOAL_SCORED         // Player scored a goal
  STARTED_MATCH       // Player started a match
  BENCHED             // Player was on the bench
  NOT_CALLED          // Player not called for match
  TRANSFER            // Player transferred to another team
  PRICE_CHANGE        // Player quotation changed
}

// Severity levels for alerts
enum AlertSeverity {
  INFO       // Informational (goal scored, started match)
  WARNING    // Worth attention (form down, benched)
  DANGER     // Important (injury, suspension, not called)
}

// Alert for a player event
model PlayerAlert {
  id           String        @id @default(cuid())

  playerId     String
  player       SerieAPlayer  @relation(fields: [playerId], references: [id], onDelete: Cascade)

  alertType    AlertType
  severity     AlertSeverity @default(INFO)

  title        String        // Short title (e.g., "Infortunio")
  message      String        // Detailed message (e.g., "Distorsione alla caviglia, 15 giorni di stop")

  // Optional match reference (for match-related alerts)
  matchId      Int?
  matchInfo    String?       // e.g., "Roma vs Juventus, Giornata 15"

  // Additional metadata as JSON (flexible for different alert types)
  metadata     Json?         // e.g., { "days_out": 15, "old_rating": 6.5, "new_rating": 7.2 }

  // Validity period (some alerts expire, like "form up" after next match)
  validFrom    DateTime      @default(now())
  validUntil   DateTime?     // null = no expiry

  createdAt    DateTime      @default(now())

  // Notifications sent to managers
  notifications PlayerAlertNotification[]

  @@index([playerId, createdAt])
  @@index([alertType, createdAt])
  @@index([createdAt])
}

// Notification sent to a manager about a player alert
model PlayerAlertNotification {
  id           String       @id @default(cuid())

  alertId      String
  alert        PlayerAlert  @relation(fields: [alertId], references: [id], onDelete: Cascade)

  memberId     String
  member       LeagueMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Read status
  isRead       Boolean      @default(false)
  readAt       DateTime?

  createdAt    DateTime     @default(now())

  // Each member gets only one notification per alert
  @@unique([alertId, memberId])
  @@index([memberId, isRead, createdAt])
  @@index([memberId, createdAt])
}


// =============================================================================
// Source: prisma/schemas/auction.prisma
// =============================================================================
// =============================================================================
// auction.prisma - Auction, AuctionBid, AuctionAppeal, AuctionAcknowledgment
// =============================================================================
//
// This file contains models for the auction system.
//
// =============================================================================

model Auction {
  id              String   @id @default(cuid())

  leagueId        String
  league          League   @relation(fields: [leagueId], references: [id])  // see: league.prisma

  marketSessionId String?
  marketSession   MarketSession? @relation(fields: [marketSessionId], references: [id])  // see: market-session.prisma

  playerId        String
  player          SerieAPlayer @relation(fields: [playerId], references: [id])  // see: player.prisma

  type            AuctionType         // see: _base.prisma
  basePrice       Int         @default(1)  // Sempre 1 per default
  currentPrice    Int

  winnerId        String?
  winner          LeagueMember? @relation("AuctionWinner", fields: [winnerId], references: [id])  // see: league.prisma

  // Per rubata: chi sta cedendo
  sellerId        String?

  // Chi ha nominato il giocatore (per primo mercato)
  nominatorId     String?

  status          AuctionStatus @default(PENDING)  // see: _base.prisma

  // Timer con reset
  timerExpiresAt  DateTime?     // Quando scade il timer attuale
  timerSeconds    Int?          // Durata timer in secondi

  startsAt        DateTime?
  endsAt          DateTime?

  createdAt       DateTime @default(now())

  // Per gestione ricorsi - chi ha preso visione della decisione
  appealDecisionAcks  Json?     // Array di memberId che hanno confermato la decisione
  // Per ripresa asta dopo ricorso ACCEPTED - chi e pronto
  resumeReadyMembers  Json?     // Array di memberId pronti a riprendere

  // Relazioni
  bids            AuctionBid[]
  acknowledgments AuctionAcknowledgment[]
  appeals         AuctionAppeal[]

  // Performance indexes as specified in REFACTORING_PLAN.md
  @@index([marketSessionId, status])
  @@index([timerExpiresAt])
  @@index([winnerId])
}

model AuctionBid {
  id          String   @id @default(cuid())

  auctionId   String
  auction     Auction  @relation(fields: [auctionId], references: [id])

  bidderId    String
  bidder      LeagueMember @relation(fields: [bidderId], references: [id])  // see: league.prisma

  userId      String
  user        User     @relation(fields: [userId], references: [id])  // see: identity.prisma

  amount      Int
  isWinning   Boolean  @default(false)

  // Admin puo annullare un'offerta
  isCancelled Boolean  @default(false)
  cancelledAt DateTime?
  cancelledBy String?   // userId dell'admin che ha annullato

  placedAt    DateTime @default(now())

  // Performance indexes as specified in REFACTORING_PLAN.md
  @@index([auctionId, isWinning])
  @@index([auctionId, placedAt])
  @@index([bidderId])
}

// Conferma visualizzazione risultato asta
model AuctionAcknowledgment {
  id          String   @id @default(cuid())

  auctionId   String
  auction     Auction  @relation(fields: [auctionId], references: [id])

  memberId    String
  member      LeagueMember @relation(fields: [memberId], references: [id])  // see: league.prisma

  // Profezia opzionale inserita dal manager
  prophecy    String?

  acknowledgedAt DateTime @default(now())

  @@unique([auctionId, memberId])
}

// Obiettivi pre-asta dei manager
// Permette di salvare giocatori target con priorità
model AuctionObjective {
  id          String   @id @default(cuid())

  // Sessione di mercato a cui si riferisce l'obiettivo
  sessionId   String
  session     MarketSession @relation(fields: [sessionId], references: [id])  // see: market-session.prisma

  // Manager che ha creato l'obiettivo
  memberId    String
  member      LeagueMember @relation(fields: [memberId], references: [id])  // see: league.prisma

  // Giocatore target
  playerId    String
  player      SerieAPlayer @relation(fields: [playerId], references: [id])  // see: player.prisma

  // Priorità (1 = alta, 2 = media, 3 = bassa)
  priority    Int      @default(2)

  // Note personali sul giocatore
  notes       String?

  // Prezzo massimo che si è disposti a pagare
  maxPrice    Int?

  // Stato: ACTIVE, ACQUIRED (giocatore acquistato), MISSED (perso ad altri)
  status      ObjectiveStatus @default(ACTIVE)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([sessionId, memberId, playerId])
  @@index([memberId, sessionId, status])
}

// Ricorsi su aste concluse
model AuctionAppeal {
  id          String   @id @default(cuid())

  auctionId   String
  auction     Auction  @relation(fields: [auctionId], references: [id])

  // Chi ha fatto il ricorso
  memberId    String
  member      LeagueMember @relation(fields: [memberId], references: [id])  // see: league.prisma

  // Motivazione del ricorso
  content     String

  // Stato del ricorso
  status      AppealStatus @default(PENDING)  // see: _base.prisma

  // Admin che ha risolto il ricorso
  resolvedById String?
  resolvedBy   LeagueMember? @relation("AppealResolver", fields: [resolvedById], references: [id])  // see: league.prisma

  // Note admin sulla risoluzione
  resolutionNote String?

  resolvedAt  DateTime?
  createdAt   DateTime @default(now())
}


// =============================================================================
// Source: prisma/schemas/chat.prisma
// =============================================================================
// =============================================================================
// chat.prisma - ChatMessage
// =============================================================================
//
// This file contains the ChatMessage model for auction/session chat.
//
// =============================================================================

model ChatMessage {
  id              String   @id @default(cuid())

  marketSessionId String
  marketSession   MarketSession @relation(fields: [marketSessionId], references: [id])  // see: market-session.prisma

  memberId        String
  member          LeagueMember @relation(fields: [memberId], references: [id])  // see: league.prisma

  content         String

  // Per messaggi di sistema (es. "Asta iniziata", "Giocatore nominato")
  isSystem        Boolean  @default(false)

  createdAt       DateTime @default(now())
}


// =============================================================================
// Source: prisma/schemas/feedback.prisma
// =============================================================================
// =============================================================================
// feedback.prisma - User Feedback & Bug Reporting System
// =============================================================================
//
// This file contains models for manager feedback/segnalazioni system.
// Allows managers to report issues and track their resolution.
//
// =============================================================================

// ==================== FEEDBACK STATUS ENUM ====================
enum FeedbackStatus {
  APERTA           // Initial state - report submitted
  IN_LAVORAZIONE   // Admin is working on it
  RISOLTA          // Issue resolved
}

// ==================== FEEDBACK CATEGORY ENUM ====================
enum FeedbackCategory {
  BUG              // Software bug
  SUGGERIMENTO     // Feature suggestion
  DOMANDA          // Question/help needed
  ALTRO            // Other
}

// ==================== USER FEEDBACK MODEL ====================
model UserFeedback {
  id              String            @id @default(cuid())

  // Who submitted
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Optional league context (if feedback is league-specific)
  leagueId        String?
  league          League?           @relation(fields: [leagueId], references: [id], onDelete: SetNull)

  // Content
  title           String
  description     String            @db.Text
  category        FeedbackCategory  @default(BUG)

  // Status tracking
  status          FeedbackStatus    @default(APERTA)

  // Optional: page/context where issue occurred
  pageContext     String?           // e.g., "contracts", "auction", "rubata"

  // GitHub integration
  githubIssueId   Int?              // GitHub issue number if created
  githubIssueUrl  String?           // Full URL to GitHub issue

  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  resolvedAt      DateTime?         // When status changed to RISOLTA

  // Relations
  responses       FeedbackResponse[]
  notifications   FeedbackNotification[]

  @@index([userId])
  @@index([leagueId])
  @@index([status])
  @@index([createdAt])
}

// ==================== FEEDBACK RESPONSE MODEL ====================
model FeedbackResponse {
  id              String            @id @default(cuid())

  // Parent feedback
  feedbackId      String
  feedback        UserFeedback      @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  // Who responded (admin/superadmin)
  adminId         String
  admin           User              @relation("FeedbackAdmin", fields: [adminId], references: [id], onDelete: Cascade)

  // Response content
  content         String            @db.Text

  // Did this response change status?
  statusChange    FeedbackStatus?   // null if no change, or the new status

  // Timestamps
  createdAt       DateTime          @default(now())

  @@index([feedbackId])
  @@index([adminId])
}

// ==================== FEEDBACK NOTIFICATION MODEL ====================
model FeedbackNotification {
  id              String            @id @default(cuid())

  // Target user (the manager who submitted feedback)
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Related feedback
  feedbackId      String
  feedback        UserFeedback      @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  // Notification type
  type            String            // "STATUS_CHANGE" | "NEW_RESPONSE"

  // Read status
  isRead          Boolean           @default(false)
  readAt          DateTime?

  // Timestamps
  createdAt       DateTime          @default(now())

  @@unique([userId, feedbackId, type])  // One notification per type per feedback per user
  @@index([userId, isRead])
  @@index([feedbackId])
}


// =============================================================================
// Source: prisma/schemas/identity.prisma
// =============================================================================
// =============================================================================
// identity.prisma - User Model
// =============================================================================
//
// This file contains the User model for authentication and identity.
//
// =============================================================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  username      String   @unique
  passwordHash  String
  emailVerified Boolean  @default(false)
  isSuperAdmin  Boolean  @default(false)  // Superadmin piattaforma (gestisce quotazioni)
  profilePhoto  String?  // URL della foto profilo (base64 o path)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Password reset
  passwordResetToken    String?   @unique
  passwordResetExpires  DateTime?

  // Relazioni
  leagueMemberships LeagueMember[]         // see: league.prisma
  sentOffers        TradeOffer[]     @relation("OfferSender")   // see: trade.prisma
  receivedOffers    TradeOffer[]     @relation("OfferReceiver") // see: trade.prisma
  auctionBids       AuctionBid[]     // see: auction.prisma
  auditLogs         AuditLog[]       // see: admin.prisma
  sentInvites       LeagueInvite[]   // see: league.prisma
  quotazioniUploads QuotazioniUpload[] // see: player.prisma

  // Feedback system
  userFeedback           UserFeedback[]             // see: feedback.prisma
  feedbackResponses      FeedbackResponse[]  @relation("FeedbackAdmin")  // see: feedback.prisma
  feedbackNotifications  FeedbackNotification[]     // see: feedback.prisma
}


// =============================================================================
// Source: prisma/schemas/league.prisma
// =============================================================================
// =============================================================================
// league.prisma - League, LeagueMember, LeagueInvite
// =============================================================================
//
// This file contains models for league management and membership.
//
// =============================================================================

model League {
  id               String   @id @default(cuid())
  name             String
  description      String?

  // Vincoli partecipanti
  minParticipants  Int      @default(6)
  maxParticipants  Int      @default(20)
  requireEvenNumber Boolean @default(true)

  initialBudget    Int      @default(500)

  // Slot rosa
  goalkeeperSlots  Int      @default(3)
  defenderSlots    Int      @default(8)
  midfielderSlots  Int      @default(8)
  forwardSlots     Int      @default(6)

  // Stato
  status           LeagueStatus @default(DRAFT)  // see: _base.prisma
  currentSeason    Int          @default(1)

  // Codice invito
  inviteCode       String   @unique @default(cuid())

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relazioni
  members          LeagueMember[]
  marketSessions   MarketSession[]    // see: market-session.prisma
  auctions         Auction[]          // see: auction.prisma
  auditLogs        AuditLog[]         // see: admin.prisma
  invites          LeagueInvite[]
  playerMovements  PlayerMovement[]   // see: movement.prisma
  prophecies       Prophecy[]         // see: movement.prisma
  prizes           Prize[]            // see: prize.prisma
  feedback         UserFeedback[]     // see: feedback.prisma
}

model LeagueMember {
  id          String   @id @default(cuid())

  userId      String
  user        User     @relation(fields: [userId], references: [id])  // see: identity.prisma

  leagueId    String
  league      League   @relation(fields: [leagueId], references: [id])

  role        MemberRole @default(MANAGER)    // see: _base.prisma
  teamName    String?
  status      MemberStatus @default(PENDING)  // see: _base.prisma

  // Come e entrato nella lega
  joinType    JoinType @default(REQUEST)      // see: _base.prisma

  // Budget
  currentBudget Int    @default(0)

  // Ordine Rubata (impostato da admin)
  rubataOrder   Int?

  // Ordine turno primo mercato (impostato da admin)
  firstMarketOrder Int?

  joinedAt    DateTime @default(now())

  // Relazioni
  roster      PlayerRoster[]                 // see: roster.prisma
  contracts   PlayerContract[]               // see: roster.prisma
  draftContracts DraftContract[]             // see: roster.prisma
  wonAuctions Auction[]        @relation("AuctionWinner")  // see: auction.prisma
  bids        AuctionBid[]                   // see: auction.prisma
  movementsFrom PlayerMovement[] @relation("MovementFrom") // see: movement.prisma
  movementsTo   PlayerMovement[] @relation("MovementTo")   // see: movement.prisma
  prophecies    Prophecy[]                   // see: movement.prisma
  auctionAcknowledgments AuctionAcknowledgment[]  // see: auction.prisma
  contractConsolidations ContractConsolidation[]  // see: market-session.prisma
  indemnityDecisions IndemnityDecision[]          // see: market-session.prisma
  prizesReceived Prize[]                     // see: prize.prisma
  prizesGiven    Prize[] @relation("PrizeAdmin")  // see: prize.prisma
  appeals        AuctionAppeal[]             // see: auction.prisma
  appealsResolved AuctionAppeal[] @relation("AppealResolver")  // see: auction.prisma
  chatMessages   ChatMessage[]               // see: chat.prisma
  sessionPrizes  SessionPrize[]              // see: prize.prisma
  rubataPreferences RubataPreference[]       // see: rubata.prisma
  auctionObjectives AuctionObjective[]       // see: auction.prisma
  alertNotifications PlayerAlertNotification[] // see: alert.prisma

  @@unique([userId, leagueId])
  @@index([leagueId, status])
  @@index([userId])
}

model LeagueInvite {
  id          String   @id @default(cuid())

  leagueId    String
  league      League   @relation(fields: [leagueId], references: [id])

  email       String
  token       String   @unique

  invitedBy   String
  inviter     User     @relation(fields: [invitedBy], references: [id])  // see: identity.prisma

  status      InviteStatus @default(PENDING)  // see: _base.prisma

  expiresAt   DateTime
  acceptedAt  DateTime?

  createdAt   DateTime @default(now())

  @@unique([leagueId, email])
}


// =============================================================================
// Source: prisma/schemas/market-session.prisma
// =============================================================================
// =============================================================================
// market-session.prisma - MarketSession, ContractConsolidation
// =============================================================================
//
// This file contains the MarketSession model and related consolidation model.
//
// NOTE: Many JSON fields in MarketSession are candidates for future normalization.
// See rubata.prisma and svincolati.prisma for planned normalized models.
//
// =============================================================================

model MarketSession {
  id          String   @id @default(cuid())

  leagueId    String
  league      League   @relation(fields: [leagueId], references: [id])  // see: league.prisma

  type        MarketType       // see: _base.prisma
  season      Int
  semester    Int      // 1 = estivo, 2 = invernale

  status      SessionStatus @default(SCHEDULED)  // see: _base.prisma
  currentPhase MarketPhase?                       // see: _base.prisma

  // ===== PRIMO MERCATO ASSOLUTO =====
  // Ruolo attualmente in asta (P, D, C, A)
  currentRole       Position?            // see: _base.prisma
  // Ordine turni per primo mercato (JSON array di leagueMemberId)
  turnOrder         Json?
  // Indice del turno corrente
  currentTurnIndex  Int?
  // Timer asta in secondi (configurabile da admin)
  auctionTimerSeconds Int @default(30)

  // ===== RUBATA =====
  // NOTE: The following JSON fields should be normalized in future.
  // See rubata.prisma for the target normalized schema (RubataBoard table).
  // Ordine rubata per questa sessione (JSON array di leagueMemberId)
  rubataOrder  Json?
  // Tabellone rubata ordinato (JSON array di {rosterId, memberId, playerId})
  rubataBoard  Json?
  // Indice corrente nel tabellone (quale giocatore e in esame)
  rubataBoardIndex Int?
  // Timer per offerta iniziale in secondi
  rubataOfferTimerSeconds Int @default(30)
  // Timer per asta rubata in secondi
  rubataAuctionTimerSeconds Int @default(15)
  // Timestamp quando il timer corrente e iniziato
  rubataTimerStartedAt DateTime?
  // Stato rubata: WAITING (aspetta admin), READY_CHECK, OFFERING (timer offerta), AUCTION_READY_CHECK (attesa pronti pre-asta), AUCTION (asta attiva), PENDING_ACK, PAUSED, COMPLETED
  rubataState String?
  // Manager pronti per iniziare/riprendere rubata (JSON array di leagueMemberId)
  rubataReadyMembers Json?
  // Info per annuncio rubata durante AUCTION_READY_CHECK (JSON: {bidderUsername, playerName, playerTeam, playerPosition, ownerUsername, basePrice})
  rubataAuctionReadyInfo Json?
  // Pending acknowledgment dopo chiusura asta rubata (JSON: {auctionId, playerId, winnerId, price, acknowledgedMembers[], pendingMembers[]})
  rubataPendingAck Json?
  // Pausa rubata: secondi rimanenti quando è stata messa in pausa
  rubataPausedRemainingSeconds Int?
  // Pausa rubata: stato da cui è stata messa in pausa (OFFERING o AUCTION)
  rubataPausedFromState String?

  // ===== ASTA SVINCOLATI =====
  // NOTE: The following JSON fields should be normalized in future.
  // See svincolati.prisma for the target normalized schema (SvincolatiTurnOrder table).
  // Ordine turni svincolati (JSON array di leagueMemberId)
  svincolatiTurnOrder     Json?
  // Indice del turno corrente
  svincolatiCurrentTurnIndex Int?
  // Timer asta svincolati in secondi
  svincolatiTimerSeconds  Int @default(30)
  // Timestamp quando il timer corrente e iniziato
  svincolatiTimerStartedAt DateTime?
  // Stato svincolati: SETUP, READY_CHECK, NOMINATION, AUCTION, PENDING_ACK, COMPLETED
  svincolatiState         String?
  // Manager pronti per la prossima asta (JSON array di leagueMemberId)
  svincolatiReadyMembers  Json?
  // Manager che hanno passato (non vogliono piu chiamare) (JSON array di leagueMemberId)
  svincolatiPassedMembers Json?
  // Manager che hanno dichiarato di aver finito la fase (non possono piu fare offerte) (JSON array di leagueMemberId)
  svincolatiFinishedMembers Json?
  // Giocatore svincolato nominato in attesa (playerId)
  svincolatiPendingPlayerId String?
  // Chi ha nominato il giocatore pending
  svincolatiPendingNominatorId String?
  // Se il nominatore ha confermato
  svincolatiNominatorConfirmed Boolean @default(false)
  // Pending acknowledgment dopo chiusura asta (JSON: {auctionId, playerId, winnerId, price, acknowledgedMembers[], pendingMembers[]})
  svincolatiPendingAck    Json?

  // ===== READY CHECK =====
  // Manager pronti per la prossima asta (JSON array di leagueMemberId)
  // Resettato quando un'asta viene nominata
  readyMembers Json?
  // Giocatore nominato in attesa di ready check (null se nessuna nomination pending)
  pendingNominationPlayerId String?
  pendingNominationPlayer   SerieAPlayer? @relation("PendingNomination", fields: [pendingNominationPlayerId], references: [id])  // see: player.prisma
  // Chi ha nominato il giocatore pending
  pendingNominatorId        String?
  // Se il nominatore ha confermato la sua scelta (gli altri vedono "SONO PRONTO" solo dopo)
  nominatorConfirmed        Boolean @default(false)

  startsAt    DateTime?
  endsAt      DateTime?

  // Timestamp inizio fase corrente (aggiornato ad ogni cambio fase)
  phaseStartedAt DateTime?

  createdAt   DateTime @default(now())

  // Relazioni
  auctions    Auction[]              // see: auction.prisma
  trades      TradeOffer[]           // see: trade.prisma
  movements   PlayerMovement[]       // see: movement.prisma
  consolidations ContractConsolidation[]
  indemnityDecisions IndemnityDecision[]
  draftContracts DraftContract[]     // see: roster.prisma
  chatMessages ChatMessage[]         // see: chat.prisma
  prizePhaseConfig PrizePhaseConfig? // see: prize.prisma
  prizeCategories  PrizeCategory[]   // see: prize.prisma
  rubataPreferences RubataPreference[] // see: rubata.prisma
  auctionObjectives AuctionObjective[] // see: auction.prisma

  // Indice per velocizzare ricerca sessioni attive per lega
  @@index([leagueId, status])
  // Indice per verificare esistenza PRIMO_MERCATO
  @@index([leagueId, type])
  // Index for performance optimization
  @@index([leagueId, currentPhase])
  @@index([status, phaseStartedAt])
}

// ==================== CONSOLIDAMENTO CONTRATTI ====================
// Traccia quali manager hanno consolidato i propri contratti durante la fase CONTRATTI
model ContractConsolidation {
  id          String   @id @default(cuid())

  sessionId   String
  session     MarketSession @relation(fields: [sessionId], references: [id])

  memberId    String
  member      LeagueMember @relation(fields: [memberId], references: [id])  // see: league.prisma

  consolidatedAt DateTime @default(now())

  @@unique([sessionId, memberId])
}

// ==================== DECISIONI INDENNIZZI ====================
// Traccia le decisioni dei manager durante la fase CALCOLO_INDENNIZZI
model IndemnityDecision {
  id          String   @id @default(cuid())

  sessionId   String
  session     MarketSession @relation(fields: [sessionId], references: [id])

  memberId    String
  member      LeagueMember @relation(fields: [memberId], references: [id])  // see: league.prisma

  // JSON array of decisions: [{rosterId, decision: 'KEEP' | 'RELEASE'}]
  decisions   Json

  decidedAt   DateTime @default(now())

  @@unique([sessionId, memberId])
}


// =============================================================================
// Source: prisma/schemas/movement.prisma
// =============================================================================
// =============================================================================
// movement.prisma - PlayerMovement, Prophecy
// =============================================================================
//
// This file contains models for tracking player movements and prophecies.
//
// =============================================================================

model PlayerMovement {
  id              String   @id @default(cuid())

  leagueId        String
  league          League   @relation(fields: [leagueId], references: [id])  // see: league.prisma

  playerId        String
  player          SerieAPlayer @relation(fields: [playerId], references: [id])  // see: player.prisma

  // Tipo movimento
  movementType    MovementType  // see: _base.prisma

  // Da chi / A chi
  fromMemberId    String?
  fromMember      LeagueMember? @relation("MovementFrom", fields: [fromMemberId], references: [id])  // see: league.prisma

  toMemberId      String?
  toMember        LeagueMember? @relation("MovementTo", fields: [toMemberId], references: [id])  // see: league.prisma

  // Dettagli movimento
  price           Int?

  // Contratto precedente (snapshot)
  oldSalary       Int?
  oldDuration     Int?
  oldClause       Int?

  // Nuovo contratto (snapshot)
  newSalary       Int?
  newDuration     Int?
  newClause       Int?

  // Riferimento all'asta/scambio se applicabile
  auctionId       String?
  tradeId         String?

  // Sessione mercato
  marketSessionId String?
  marketSession   MarketSession? @relation(fields: [marketSessionId], references: [id])  // see: market-session.prisma

  createdAt       DateTime @default(now())

  // Relazioni
  prophecies      Prophecy[]
}

model Prophecy {
  id              String   @id @default(cuid())

  leagueId        String
  league          League   @relation(fields: [leagueId], references: [id])  // see: league.prisma

  playerId        String
  player          SerieAPlayer @relation(fields: [playerId], references: [id])  // see: player.prisma

  // Chi ha fatto la profezia
  authorId        String
  author          LeagueMember @relation(fields: [authorId], references: [id])  // see: league.prisma

  // Movimento associato
  movementId      String
  movement        PlayerMovement @relation(fields: [movementId], references: [id])

  // Tipo: acquirente o cedente
  authorRole      ProphecyRole  // see: _base.prisma

  // Contenuto profezia
  content         String

  createdAt       DateTime @default(now())

  @@unique([movementId, authorId])
}


// =============================================================================
// Source: prisma/schemas/player.prisma
// =============================================================================
// =============================================================================
// player.prisma - SerieAPlayer, QuotazioniUpload
// =============================================================================
//
// This file contains models for Serie A players and quotation imports.
//
// =============================================================================

model SerieAPlayer {
  id           String   @id @default(cuid())
  externalId   String?  @unique     // ID dal file quotazioni (es. "123")
  name         String
  team         String
  position     Position             // see: _base.prisma
  quotation    Int      @default(1)
  age          Int?
  isActive     Boolean  @default(true)

  // Status nella lista quotazioni
  listStatus   PlayerListStatus @default(IN_LIST)  // see: _base.prisma

  // Motivo uscita dalla lista (se non piu' in lista)
  exitReason   PlayerExitReason?  // see: _base.prisma
  exitDate     DateTime?          // Data di uscita dalla lista

  // API-Football integration
  apiFootballId    Int?       @unique  // Player ID from API-Football v3
  apiFootballStats Json?               // Stats JSON blob from API-Football
  statsSyncedAt    DateTime?           // Last stats sync timestamp

  // Seasonality cache (computed from matchRatings)
  seasonalStatsCache    Json?       // { monthly_breakdown: {...}, hot_months: [...], avg_rating: N }
  seasonalStatsCachedAt DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relazioni
  rosters      PlayerRoster[]       // see: roster.prisma
  auctions     Auction[]            // see: auction.prisma
  movements    PlayerMovement[]     // see: movement.prisma
  prophecies   Prophecy[]           // see: movement.prisma
  pendingNominations MarketSession[] @relation("PendingNomination")  // see: market-session.prisma
  rubataPreferences RubataPreference[] // see: rubata.prisma
  auctionObjectives AuctionObjective[] // see: auction.prisma
  matchRatings PlayerMatchRating[]  // see below
  alerts       PlayerAlert[]        // see: alert.prisma
}

model QuotazioniUpload {
  id            String   @id @default(cuid())

  uploadedById  String
  uploadedBy    User     @relation(fields: [uploadedById], references: [id])  // see: identity.prisma

  fileName      String
  sheetName     String

  // Risultati import
  playersCreated   Int
  playersUpdated   Int
  playersNotInList Int
  totalProcessed   Int
  errors           Json?    // Array of error strings

  createdAt     DateTime @default(now())
}

// Cache for API-Football players to enable searching without repeated API calls
model ApiFootballPlayerCache {
  id        Int      @id  // API-Football player ID (not auto-generated)
  name      String
  team      String
  teamId    Int?           // API-Football team ID for logo URLs
  position  String
  photo     String?        // Player photo URL from API-Football
  cachedAt  DateTime @default(now())

  @@index([name])
  @@index([team])
}

// Ratings per singola partita (per calcolo stagionalità)
model PlayerMatchRating {
  id              String   @id @default(cuid())
  playerId        String
  player          SerieAPlayer @relation(fields: [playerId], references: [id], onDelete: Cascade)

  apiFixtureId    Int           // API-Football fixture ID
  matchDate       DateTime
  season          String        // "2024-2025"
  round           String?       // "Regular Season - 15"

  rating          Float?        // Rating 0-10 (null se non ha giocato)
  minutesPlayed   Int?
  goals           Int?
  assists         Int?

  createdAt       DateTime @default(now())

  @@unique([playerId, apiFixtureId])
  @@index([playerId, matchDate])
  @@index([matchDate])
  @@index([season])
}


// =============================================================================
// Source: prisma/schemas/prize.prisma
// =============================================================================
// =============================================================================
// prize.prisma - Prize, PrizeCategory, SessionPrize, PrizePhaseConfig
// =============================================================================
//
// This file contains models for the prize/bonus system.
//
// =============================================================================

// ==================== PREMI (Legacy) ====================
// Traccia i premi assegnati dall'admin ai manager
model Prize {
  id          String   @id @default(cuid())

  leagueId    String
  league      League   @relation(fields: [leagueId], references: [id])  // see: league.prisma

  memberId    String
  member      LeagueMember @relation(fields: [memberId], references: [id])  // see: league.prisma

  adminId     String
  admin       LeagueMember @relation("PrizeAdmin", fields: [adminId], references: [id])  // see: league.prisma

  amount      Int
  reason      String?

  createdAt   DateTime @default(now())
}

// ==================== FASE PREMI (MERCATO RICORRENTE) ====================
// Configurazione fase PREMI per sessione di mercato
model PrizePhaseConfig {
  id                      String        @id @default(cuid())
  marketSessionId         String        @unique
  marketSession           MarketSession @relation(fields: [marketSessionId], references: [id], onDelete: Cascade)  // see: market-session.prisma
  baseReincrement         Int           @default(100)  // Re-incremento base uguale per tutti
  indemnityConsolidated   Boolean       @default(false)  // true quando admin consolida gli indennizzi
  indemnityConsolidatedAt DateTime?     // Data/ora consolidamento indennizzi
  isFinalized             Boolean       @default(false)
  finalizedAt             DateTime?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
}

// Categoria premio (es. "Classifica Portieri", "Indennizzo Partenza Estero")
model PrizeCategory {
  id                String         @id @default(cuid())
  marketSessionId   String
  marketSession     MarketSession  @relation(fields: [marketSessionId], references: [id], onDelete: Cascade)  // see: market-session.prisma
  name              String
  isSystemPrize     Boolean        @default(false)  // true per "Indennizzo Partenza Estero"
  managerPrizes     SessionPrize[]
  createdAt         DateTime       @default(now())

  @@unique([marketSessionId, name])
}

// Premio assegnato a un manager per questa sessione
model SessionPrize {
  id              String        @id @default(cuid())
  prizeCategoryId String
  prizeCategory   PrizeCategory @relation(fields: [prizeCategoryId], references: [id], onDelete: Cascade)
  leagueMemberId  String
  leagueMember    LeagueMember  @relation(fields: [leagueMemberId], references: [id], onDelete: Cascade)  // see: league.prisma
  amount          Int           // Importo assegnato
  createdAt       DateTime      @default(now())

  @@unique([prizeCategoryId, leagueMemberId])
}


// =============================================================================
// Source: prisma/schemas/roster.prisma
// =============================================================================
// =============================================================================
// roster.prisma - PlayerRoster, PlayerContract, DraftContract
// =============================================================================
//
// This file contains models for player rosters and contracts.
//
// =============================================================================

model PlayerRoster {
  id              String   @id @default(cuid())

  leagueMemberId  String
  leagueMember    LeagueMember @relation(fields: [leagueMemberId], references: [id])  // see: league.prisma

  playerId        String
  player          SerieAPlayer @relation(fields: [playerId], references: [id])  // see: player.prisma

  acquisitionPrice Int
  acquisitionType  AcquisitionType  // see: _base.prisma

  status          RosterStatus @default(ACTIVE)  // see: _base.prisma
  acquiredAt      DateTime     @default(now())
  releasedAt      DateTime?

  // Relazioni
  contract        PlayerContract?
  draftContract   DraftContract?

  @@unique([leagueMemberId, playerId, status])
  @@index([leagueMemberId, status])
  @@index([playerId])
}

model PlayerContract {
  id              String   @id @default(cuid())

  rosterId        String   @unique
  roster          PlayerRoster @relation(fields: [rosterId], references: [id])

  leagueMemberId  String
  leagueMember    LeagueMember @relation(fields: [leagueMemberId], references: [id])  // see: league.prisma

  // Parametri contratto
  salary          Int      // Ingaggio
  duration        Int      // Durata (1-4 semestri)
  initialSalary   Int      // Per validazione rinnovi
  initialDuration Int      // Per validazione rinnovi

  // Calcolato
  rescissionClause Int     // salary * multiplier

  // Bozza rinnovo (staging area)
  draftSalary     Int?     // Nuovo ingaggio proposto
  draftDuration   Int?     // Nuova durata proposta
  draftReleased   Boolean  @default(false)  // Marcato per taglio (pending)
  draftExitDecision String?  // null=INDECISO, "KEEP"=tieni, "RELEASE"=rilascia (solo giocatori usciti)

  signedAt        DateTime @default(now())
  expiresAt       DateTime?

  // Storico rinnovi
  renewalHistory  Json?    // [{salary, duration, renewedAt}]
}

// Bozza per nuovi contratti (giocatori senza contratto)
model DraftContract {
  id              String   @id @default(cuid())

  rosterId        String   @unique
  roster          PlayerRoster @relation(fields: [rosterId], references: [id])

  memberId        String
  member          LeagueMember @relation(fields: [memberId], references: [id])  // see: league.prisma

  sessionId       String
  session         MarketSession @relation(fields: [sessionId], references: [id])  // see: market-session.prisma

  salary          Int
  duration        Int

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}


// =============================================================================
// Source: prisma/schemas/rubata.prisma
// =============================================================================
// =============================================================================
// rubata.prisma - Rubata Phase Models
// =============================================================================
//
// This file documents the rubata-related fields currently stored as JSON
// in MarketSession, and provides the target normalized schema for future migration.
//
// =============================================================================

// =============================================================================
// CURRENT STATE (JSON fields in MarketSession - see: market-session.prisma)
// =============================================================================
//
// The following fields in MarketSession store rubata data as JSON:
//
// - rubataOrder: Json?           // Array of leagueMemberId for turn order
// - rubataBoard: Json?           // Array of {rosterId, memberId, playerId}
// - rubataBoardIndex: Int?       // Current index in the board
// - rubataState: String?         // Current state machine state
// - rubataReadyMembers: Json?    // Array of ready member IDs
// - rubataAuctionReadyInfo: Json? // Info for auction announcement
// - rubataPendingAck: Json?      // Pending acknowledgment data
//
// =============================================================================

// =============================================================================
// FUTURE NORMALIZED SCHEMA
// =============================================================================
//
// TODO: In a future migration, the JSON fields above should be normalized
// to the following tables. This will provide:
// - Better query performance
// - Referential integrity
// - Type safety
// - Easier debugging
//
// NOTE: The models below are commented out as they are not yet implemented.
// Uncomment and migrate when ready to normalize.
// =============================================================================

// // Tabellone rubata - lista ordinata di giocatori da esaminare
// model RubataBoard {
//   id              String   @id @default(cuid())
//   sessionId       String
//   session         MarketSession @relation(fields: [sessionId], references: [id])
//   rosterId        String
//   roster          PlayerRoster @relation(fields: [rosterId], references: [id])
//   memberId        String
//   member          LeagueMember @relation(fields: [memberId], references: [id])
//   playerId        String
//   player          SerieAPlayer @relation(fields: [playerId], references: [id])
//   orderIndex      Int      // Position in the board
//   status          RubataBoardStatus @default(PENDING)
//   createdAt       DateTime @default(now())
//
//   @@unique([sessionId, orderIndex])
//   @@index([sessionId, status])
//   @@index([memberId])
// }
//
// enum RubataBoardStatus {
//   PENDING     // Not yet examined
//   OFFERING    // Currently in offering phase
//   AUCTION     // Currently in auction
//   COMPLETED   // Transfer completed
//   SKIPPED     // No offers received, kept by owner
// }

// // Stato ready dei manager per rubata
// model RubataReadyStatus {
//   id              String   @id @default(cuid())
//   sessionId       String
//   memberId        String
//   isReady         Boolean  @default(false)
//   readyAt         DateTime?
//
//   @@unique([sessionId, memberId])
// }

// // Offerte durante la fase rubata
// model RubataOffer {
//   id              String   @id @default(cuid())
//   sessionId       String
//   boardEntryId    String   // Reference to RubataBoard entry
//   bidderId        String   // LeagueMember making the offer
//   amount          Int
//   offeredAt       DateTime @default(now())
//   isInitialOffer  Boolean  @default(false)  // The first offer that triggers auction
//
//   @@index([boardEntryId])
//   @@index([sessionId, bidderId])
// }

// =============================================================================
// ACTIVE MODELS - Preferenze strategiche rubata
// =============================================================================

// Preferenze dei manager per la fase rubata (watchlist, auto-pass, budget max, etc.)
model RubataPreference {
  id          String   @id @default(cuid())

  sessionId   String
  session     MarketSession @relation(fields: [sessionId], references: [id])

  memberId    String
  member      LeagueMember @relation(fields: [memberId], references: [id])

  playerId    String
  player      SerieAPlayer @relation(fields: [playerId], references: [id])

  // Preferenze
  isWatchlist Boolean  @default(false)  // Giocatore nella watchlist
  isAutoPass  Boolean  @default(false)  // Salta automaticamente (non fare offerte)
  maxBid      Int?                       // Budget massimo per questo giocatore
  priority    Int?                       // Priorità (1 = più alta)
  notes       String?                    // Note private del manager

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([sessionId, memberId, playerId])
  @@index([sessionId, memberId])
  @@index([memberId, isWatchlist])
}


// =============================================================================
// Source: prisma/schemas/trade.prisma
// =============================================================================
// =============================================================================
// trade.prisma - TradeOffer
// =============================================================================
//
// This file contains models for the trading system between managers.
//
// =============================================================================

model TradeOffer {
  id              String   @id @default(cuid())

  marketSessionId String
  marketSession   MarketSession @relation(fields: [marketSessionId], references: [id])  // see: market-session.prisma

  senderId        String
  sender          User     @relation("OfferSender", fields: [senderId], references: [id])  // see: identity.prisma

  receiverId      String
  receiver        User     @relation("OfferReceiver", fields: [receiverId], references: [id])  // see: identity.prisma

  // Offerta
  offeredPlayers  Json     // [playerId, ...]
  offeredBudget   Int      @default(0)

  // Richiesta
  requestedPlayers Json    // [playerId, ...]
  requestedBudget  Int     @default(0)

  status          TradeStatus @default(PENDING)  // see: _base.prisma

  // Per vincolo anti-ritroso
  involvedPlayers Json     // tutti i playerId coinvolti

  message         String?

  createdAt       DateTime @default(now())
  expiresAt       DateTime?  // Scadenza dell'offerta
  respondedAt     DateTime?

  // Controproposta
  parentOfferId   String?
  parentOffer     TradeOffer?  @relation("CounterOffers", fields: [parentOfferId], references: [id])
  counterOffers   TradeOffer[] @relation("CounterOffers")
}
