// =============================================================================
// player.prisma - SerieAPlayer, QuotazioniUpload
// =============================================================================
//
// This file contains models for Serie A players and quotation imports.
//
// =============================================================================

model SerieAPlayer {
  id           String   @id @default(cuid())
  externalId   String?  @unique     // ID dal file quotazioni (es. "123")
  name         String
  team         String
  position     Position             // see: _base.prisma
  quotation    Int      @default(1)
  age          Int?
  isActive     Boolean  @default(true)

  // Status nella lista quotazioni
  listStatus   PlayerListStatus @default(IN_LIST)  // see: _base.prisma

  // Motivo uscita dalla lista (se non piu' in lista)
  exitReason   PlayerExitReason?  // see: _base.prisma
  exitDate     DateTime?          // Data di uscita dalla lista

  // API-Football integration
  apiFootballId    Int?       @unique  // Player ID from API-Football v3
  apiFootballStats Json?               // Stats JSON blob from API-Football
  statsSyncedAt    DateTime?           // Last stats sync timestamp

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relazioni
  rosters      PlayerRoster[]       // see: roster.prisma
  auctions     Auction[]            // see: auction.prisma
  movements    PlayerMovement[]     // see: movement.prisma
  prophecies   Prophecy[]           // see: movement.prisma
  pendingNominations MarketSession[] @relation("PendingNomination")  // see: market-session.prisma
  rubataPreferences RubataPreference[] // see: rubata.prisma
  auctionObjectives AuctionObjective[] // see: auction.prisma
  matchRatings PlayerMatchRating[]  // Match-by-match ratings from API-Football
  contractHistory ContractHistory[]  // see: contract-history.prisma
}

model QuotazioniUpload {
  id            String   @id @default(cuid())

  uploadedById  String
  uploadedBy    User     @relation(fields: [uploadedById], references: [id])  // see: identity.prisma

  fileName      String
  sheetName     String

  // Risultati import
  playersCreated   Int
  playersUpdated   Int
  playersNotInList Int
  totalProcessed   Int
  errors           Json?    // Array of error strings

  createdAt     DateTime @default(now())
}

// Cache for API-Football players to enable searching without repeated API calls
model ApiFootballPlayerCache {
  id        Int      @id  // API-Football player ID (not auto-generated)
  name      String
  team      String
  teamId    Int?           // API-Football team ID for logo URLs
  position  String
  photo     String?        // Player photo URL from API-Football
  cachedAt  DateTime @default(now())

  @@index([name])
  @@index([team])
}

// Match-by-match player ratings from API-Football /fixtures/players endpoint
// Accurate source for stats (replaces apiFootballStats blob)
model PlayerMatchRating {
  id            String   @id @default(cuid())

  playerId      String
  player        SerieAPlayer @relation(fields: [playerId], references: [id])

  apiFixtureId  Int              // API-Football fixture ID
  matchDate     DateTime
  season        String           // e.g. "2025-2026"
  round         String?          // e.g. "Regular Season - 15"

  rating        Float?           // Match rating (e.g. 7.2)
  minutesPlayed Int?             // Minutes played in match
  goals         Int?             // Goals scored
  assists       Int?             // Assists made

  createdAt     DateTime @default(now())

  @@unique([playerId, apiFixtureId])
  @@index([playerId, season])
  @@index([season])
}

// Sync log for tracking API-Football scheduler runs
model ApiFootballSyncLog {
  id                String    @id @default(cuid())
  jobType           String    // "MATCH_RATINGS" | "SEASON_STATS" | "CACHE_REFRESH"
  status            String    // "SUCCESS" | "PARTIAL" | "FAILED"
  fixturesProcessed Int       @default(0)
  apiCallsUsed      Int       @default(0)
  details           Json?
  startedAt         DateTime
  completedAt       DateTime?
  createdAt         DateTime  @default(now())

  @@index([jobType, createdAt])
}

// Tracks which API-Football fixtures have already been synced
model ApiFootballFixtureSync {
  apiFixtureId     Int      @id  // API-Football fixture ID (not auto-generated)
  round            String?
  matchDate        DateTime
  playersProcessed Int      @default(0)
  syncedAt         DateTime @default(now())

  @@index([matchDate])
}
