// =============================================================================
// identity.prisma - User Model
// =============================================================================
//
// This file contains the User model for authentication and identity.
//
// =============================================================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  username      String   @unique
  passwordHash  String
  emailVerified Boolean  @default(false)
  isSuperAdmin  Boolean  @default(false)  // Superadmin piattaforma (gestisce quotazioni)
  profilePhoto  String?  // URL della foto profilo (base64 o path)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Password reset
  passwordResetToken    String?   @unique
  passwordResetExpires  DateTime?

  // Account lockout
  failedLoginAttempts  Int       @default(0)
  lockedUntil          DateTime?
  lastFailedLogin      DateTime?

  // Relazioni
  leagueMemberships LeagueMember[]         // see: league.prisma
  sentOffers        TradeOffer[]     @relation("OfferSender")   // see: trade.prisma
  receivedOffers    TradeOffer[]     @relation("OfferReceiver") // see: trade.prisma
  auctionBids       AuctionBid[]     // see: auction.prisma
  auditLogs         AuditLog[]       // see: admin.prisma
  sentInvites       LeagueInvite[]   // see: league.prisma
  quotazioniUploads QuotazioniUpload[] // see: player.prisma

  // Feedback system
  userFeedback           UserFeedback[]             // see: feedback.prisma
  feedbackResponses      FeedbackResponse[]  @relation("FeedbackAdmin")  // see: feedback.prisma
  feedbackNotifications  FeedbackNotification[]     // see: feedback.prisma

  // Token rotation
  refreshTokens           RefreshToken[]

  // Push notifications
  pushSubscriptions       PushSubscription[]
  notificationPreference  NotificationPreference?
}

// =============================================================================
// Refresh Token Rotation
// =============================================================================

model RefreshToken {
  id          String   @id @default(cuid())
  userId      String
  tokenHash   String   @unique    // SHA-256 hash del refresh token
  familyId    String              // Identifica la catena di token (per detect reuse)
  isRevoked   Boolean  @default(false)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([familyId])
  @@index([expiresAt])
}

// =============================================================================
// Push Notification Models
// =============================================================================

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
}

model NotificationPreference {
  id              String   @id @default(cuid())
  userId          String   @unique
  pushEnabled     Boolean  @default(false)
  tradeOffers     Boolean  @default(true)
  contractExpiry  Boolean  @default(true)
  auctionStart    Boolean  @default(true)
  phaseChange     Boolean  @default(true)
  updatedAt       DateTime @updatedAt

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
